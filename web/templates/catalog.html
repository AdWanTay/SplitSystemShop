<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Каталог сплит-систем | ClimateHome - Продаем и устанавливаем сплит-системы в Уфе</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/web/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/web/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/web/static/favicon/favicon-16x16.png">
    <link rel="manifest" href="/web/static/favicon/site.webmanifest">

    <link rel="stylesheet" href="/web/static/css/main.css"/>
    <link rel="stylesheet" href="/web/static/css/elements.css"/>

    <script src="https://static.elfsight.com/platform/platform.js" async></script>
    <div class="elfsight-app-e4363121-2d4f-4914-8220-73508a36cd9e" data-elfsight-app-lazy></div>

    <style>
        aside {
            max-width: 420px;
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            height: max-content;
            overflow-y: auto;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label.title {
            display: block;
            margin-bottom: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333333;
        }

        .checkbox-button, .radio-button {
            display: inline-block;
            background: #f1f1f1;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 6px 10px;
            margin: 4px 6px 4px 0;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
            transition: all 0.2s ease;
        }

        .checkbox-button input, .radio-button input {
            display: none;
        }

        .checkbox-button.checked, .radio-button.checked {
            background: #5db0ff;
            color: white;
            border-color: #5db0ff;
        }

        select, input[type="range"], input[type="number"] {
            width: 100%;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid #dcdcdc;
            font-size: 14px;
            accent-color: #2989e5;
        }

        .filter-actions {
            margin-top: 24px;
        }

        .btn-apply {
            display: block;
            width: 100%;
            padding: 10px;
        }

        #area-range-label, #cooling-range-label {
            font-size: .875rem;
            padding: .3rem 1rem;
            border: 1px solid #dcdcdc;
            border-radius: 1000px;
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
{{template "header" .}}

<main class="main">

    <section class="catalog products">
        <h2>Каталог | Cплит-системы в Уфе</h2>

        <div class="catalog__container">
            <aside>
                <div class="filter-group">
                    <label class="title">Бренд</label>
                    <div id="brand-checkboxes">
                        {{ range .brands }}
                        <label class='checkbox-button'><input type='checkbox' value='{{.ID}}'/>{{.Name}}</label>
                        {{ end }}
                    </div>
                </div>

                <div class="filter-group">
                    <label class="title">Рекомендуемая площадь (м²)</label>
                    <input type="range" min="0" max="5" step="1" value="0" id="area-range">
                    <div style="text-align: center;"><span id="area-range-label"></span></div>
                </div>

                <div class="filter-group">
                    <label class="title">Мощность охлаждения (кВт)</label>
                    <input type="range" min="0" max="4" step="1" value="0" id="power-range">
                    <div style="text-align: center;"><span id="cooling-range-label"></span></div>
                </div>

                <div class="filter-group">
                    <label class="title">Тип сплит-системы</label>
                    <div id="type-checkboxes">
                        {{ range .types }}
                        <label class="checkbox-button"><input type="checkbox" value="{{.ID}}"/>{{.Name}}</label>
                        {{end}}
                    </div>
                </div>

                <div class="filter-group">
                    <label class="title">Цена (₽)</label>
                    <div style="display: flex; gap: 1rem; margin-bottom: .5rem">
                        <input type="number" placeholder="Цена от" id="price-from"/>
                        <input type="number" placeholder="Цена до" id="price-to"/>
                    </div>
                    <div>
                        <label class="radio-button"><input type="radio" name="cost"
                                                           value="0-15000"/>менее 15000</label>
                        <label class="radio-button"><input type="radio" name="cost"
                                                           value="15001-20000"/>15001-20000</label>
                        <label class="radio-button"><input type="radio" name="cost"
                                                           value="20001-25000"/>20001-25000</label>
                        <label class="radio-button"><input type="radio" name="cost"
                                                           value="25001-35000"/>25001-35000</label>
                        <label class="radio-button"><input type="radio" name="cost"
                                                           value="35001-45000"/>35001-45000</label>
                        <label class="radio-button"><input type="radio" name="cost" value="45001-100000"/>более
                            45001</label>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="title">Инвертор</label>
                    <div>
                        <label class="radio-button"><input type="radio" name="inverter" value="1"/>Есть</label>
                        <label class="radio-button"><input type="radio" name="inverter" value="0"/>Нет</label>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="title">Мин. уровень шума (дБ)</label>
                    <select>
                        <option value="">-- выберите значение --</option>
                        <option value="0-20">менее 20</option>
                        <option value="20-24,9">20-24,9</option>
                        <option value="25-29,9">25-29,9</option>
                        <option value="30-39,9">30-39,9</option>
                        <option value="40-10000">40 и более</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="title">Макс. уровень шума (дБ)</label>
                    <select>
                        <option value="">-- выберите значение --</option>
                        <option value="0-29,9">менее 29,9</option>
                        <option value="30-34,9">30-34,9</option>
                        <option value="35-39,9">35-39,9</option>
                        <option value="40-44,9">40-44,9</option>
                        <option value="45-49,9">45-49,9</option>
                        <option value="50-10000">50 и более</option>
                    </select>
                </div>

                <div id="extra-filters">
                    <div class="filter-group">
                        <label class="title">Основные режимы</label>
                        <div id="modes-checkboxes">
                            {{ range .modes }}
                            <label class="checkbox-button"><input type="checkbox" value="{{.ID}}"/>{{.Name}}</label>
                            {{end}}
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="title">Класс энергопотребления (Охлаждение)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            {{ range .energy_classes }}
                            <option value="{{.ID}}">{{.Name}}</option>
                            {{ end }}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Класс энергопотребления (Обогрев)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            {{ range .energy_classes }}
                            <option value="{{.ID}}">{{.Name}}</option>
                            {{ end }}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Вес внешнего блока (кг)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="0-24,99">Менее 24,99</option>
                            <option value="25-29,99">25 - 29,99</option>
                            <option value="30-39,99">30 - 39,99</option>
                            <option value="40-49,99">40 - 49,99</option>
                            <option value="50-59,99">50 - 59,99</option>
                            <option value="60-10000">60 и более</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Ширина внешнего блока (мм)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="0-699">Менее 699</option>
                            <option value="700-799">700 - 799</option>
                            <option value="800-899">800 - 899</option>
                            <option value="900-999">900 - 999</option>
                            <option value="1000-10000">1 000 и более</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Высота внешнего блока (мм)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="0-499">Менее 449</option>
                            <option value="450-499">450 - 499</option>
                            <option value="500-549">500 - 549</option>
                            <option value="550-599">550 - 599</option>
                            <option value="600-649">600 - 649</option>
                            <option value="650-10000">650 и более</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Глубина внешнего блока (мм)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="0-249">Менее 249</option>
                            <option value="250-299">250 - 299</option>
                            <option value="300-349">300 - 349</option>
                            <option value="350-449">350 - 449</option>
                            <option value="450-499">450 - 499</option>
                            <option value="500-10000">500 и более</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Глубина внутреннего блока (мм)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="0-199">Менее 199</option>
                            <option value="199,1 - 249">199.1 - 249</option>
                            <option value="249,1 - 299">249.1 - 299</option>
                            <option value="299,1 - 499">299.1 - 499</option>
                            <option value="499,1-10000">499.1 и более</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Ширина внутреннего блока (мм)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="0-499">Менее 499</option>
                            <option value="500-699">500 - 699</option>
                            <option value="700-799">700 - 799</option>
                            <option value="800-899">800 - 899</option>
                            <option value="900-1199">900 - 1 199</option>
                            <option value="1200-10000">1 200 и более</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Вес внутреннего блока (кг)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="">Менее 7.99</option>
                            <option value="8-9,99">8 - 9.99</option>
                            <option value="10-11,99">10 - 11.99</option>
                            <option value="12-14,99">12 - 14.99</option>
                            <option value="15-19,99">15 - 19.99</option>
                            <option value="20-10000">20 и более</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="title">Высота внутреннего блока (мм)</label>
                        <select>
                            <option value="">-- выберите значение --</option>
                            <option value="0-199">Менее 199</option>
                            <option value="200-299">200 - 299</option>
                            <option value="300-399">300 - 399</option>
                            <option value="400-699">400 - 699</option>
                            <option value="700-10000">700 и более</option>
                        </select>
                    </div>
                </div>

                <button id="toggle-filters" class="btn-apply primary-btn" style="margin-top: 12px;">Все фильтры</button>

                <div class="filter-actions" onclick="applyButtonPress()">
                    <button class="btn-apply accent-btn">Применить фильтры</button>
                </div>
            </aside>

            <div class="products__container">
                <div class="products__filters">
                    <label class="filter-radio">
                        <input type="radio" name="sort_filter" value="rating_desc" checked>
                        <span class="radio-label">Высокий рейтинг</span>
                    </label>
                    <label class="filter-radio">
                        <input type="radio" name="sort_filter" value="price_asc">
                        <span class="radio-label">По возрастанию цены</span>
                    </label>
                    <label class="filter-radio">
                        <input type="radio" name="sort_filter" value="price_desc">
                        <span class="radio-label">По убыванию цены</span>
                    </label>
                </div>
                <div class="products__grid" id="products__grid"></div>
            </div>
        </div>
    </section>

    {{template "calc-banner" .}}

    {{template "popular-products" .}}

    {{template "contact-form" .}}

</main>

{{template "footer" .}}}

<script>
    document.querySelectorAll('input[name="cost"]').forEach(radio => {
        radio.addEventListener('click', () => {
            const priceFrom = document.getElementById('price-from');
            const priceTo = document.getElementById('price-to');
            const parent = radio.parentElement;
            console.log(parent.classList)

            if (parent.classList.contains('checked')) {
                priceFrom.value = '';
                priceTo.value = '';
                parent.classList.remove('checked');
                radio.checked = false;
            } else {
                document.querySelectorAll('label.radio-button.checked').forEach(label => {
                    label.classList.remove('checked');
                });

                const [min, max] = radio.value.split('-');
                priceFrom.value = min || '';
                priceTo.value = max || '';
                parent.classList.add('checked');
            }
        });
    });

    ['price-from', 'price-to'].forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener('input', () => {
            document.querySelectorAll('input[name="cost"]').forEach(radio => {
                const parent = radio.parentElement;
                parent.classList.remove('checked');
            });
        })
    });

</script>
<script>
    const toggleBtn = document.getElementById('toggle-filters');
    const extraFilters = document.getElementById('extra-filters');
    let isVisible = false;

    extraFilters.style.display = 'none';

    toggleBtn.addEventListener('click', () => {
        isVisible = !isVisible;
        extraFilters.style.display = isVisible ? 'block' : 'none';
        toggleBtn.textContent = isVisible ? 'Скрыть фильтры' : 'Все фильтры';
    });
</script>
<script>
    document.querySelectorAll('input[name="sort_filter"]').forEach(radio => {
        radio.addEventListener('change', () => {
            // const selectedValue = e.target.value;
            load();
        });
    });
</script>

<script>
    let applyPressed = false
    load()

    //TODO: сброс фильтров


    function getParams() {
        const params = new URLSearchParams();

        function appendRangeFromSelect(selectEl, paramPrefix) {
            const value = selectEl?.value;
            if (value && value !== "") {
                const [min, max] = value.replace(',', '.').split('-');
                if (min !== undefined && max !== undefined) {
                    params.append(`${paramPrefix}_min`, parseFloat(min));
                    params.append(`${paramPrefix}_max`, parseFloat(max));
                }
            }
        }

        function appendRangeFromRange(value, paramPrefix) {
            if (value && value !== "") {
                const [min, max] = value.replace(',', '.').split('–');
                if (min !== undefined && max !== undefined) {
                    params.append(`${paramPrefix}_min`, parseFloat(min));
                    params.append(`${paramPrefix}_max`, parseFloat(max));
                }
            }
        }

        // Бренды
        document.querySelectorAll('#brand-checkboxes input[type="checkbox"]:checked')
            .forEach(cb => params.append('brand', cb.value));

        // Типы
        document.querySelectorAll('#type-checkboxes input[type="checkbox"]:checked')
            .forEach(cb => params.append('type', cb.value));

        // Режимы
        document.querySelectorAll('#modes-checkboxes input[type="checkbox"]:checked')
            .forEach(cb => params.append('mode', cb.value));


        // Инвертор
        const inverter = document.querySelector('input[name="inverter"]:checked')?.value;
        if (inverter !== undefined) {
            params.append('has_inverter', inverter);
        }

        // Цена
        const minPrice = document.getElementById('price-from')?.value;
        const maxPrice = document.getElementById('price-to')?.value;
        if (minPrice) params.append('price_min', Number(minPrice) * 100);
        if (maxPrice) params.append('price_max', Number(maxPrice) * 100);

        appendRangeFromSelect(document.querySelectorAll('select')[0], 'min_noise_level');
        appendRangeFromSelect(document.querySelectorAll('select')[1], 'max_noise_level');

        const classCooling = document.querySelectorAll('select')[2]?.value;
        if (classCooling) params.append('energy_class_cooling', classCooling);

        const classHeating = document.querySelectorAll('select')[3]?.value;
        if (classHeating) params.append('energy_class_heating', classHeating);

        appendRangeFromSelect(document.querySelectorAll('select')[4], 'external_weight');
        appendRangeFromSelect(document.querySelectorAll('select')[5], 'external_width');
        appendRangeFromSelect(document.querySelectorAll('select')[6], 'external_height');
        appendRangeFromSelect(document.querySelectorAll('select')[7], 'external_depth');
        appendRangeFromSelect(document.querySelectorAll('select')[8], 'internal_depth');
        appendRangeFromSelect(document.querySelectorAll('select')[9], 'internal_width');
        appendRangeFromSelect(document.querySelectorAll('select')[10], 'internal_weight');
        appendRangeFromSelect(document.querySelectorAll('select')[11], 'internal_height');

        // Площадь и мощность (range-слайдеры)
        const areaValue = document.getElementById('area-range')?.value;
        if (areaValue && areaValue > 0) {
            appendRangeFromRange(areaValues[areaValue], 'recommended_area');
        }
        const powerValue = document.getElementById('power-range')?.value;
        if (powerValue && powerValue > 0) {
            appendRangeFromRange(powerValues[powerValue], 'cooling_power');
        }
        return params
    }

    function applyButtonPress() {
        applyPressed = true
        load()
    }

    function load() {
        //TODO: только тыкнутые пользователем фильтры применялись
        //TODO: корзина и любимые (после регистрации)

        const params = getParams();

        const selectedSort = document.querySelector('input[name="sort_filter"]:checked');
        const sortParams = new URLSearchParams()
        if (selectedSort) {
            sortParams.append('sort', selectedSort.value);
        }

        const fullUrl = "/api/split-systems?" + sortParams.toString() + (applyPressed ? "&" + params.toString() : '');

        console.log("Загрузка с фильтрами:", fullUrl);
        fetch(fullUrl)
            .then(response => {
                if (!response.ok) throw new Error('Ошибка загрузки');
                return response.json();
            })
            .then(data => {
                console.log("Ответ с сервера:", data);
                renderProducts(data.items)
            })
            .catch(err => {
                console.error("Ошибка:", err);
            });
    }

    function renderProducts(products) {
        const container = document.getElementById('products__grid');
        container.innerHTML = '';

        if (!products.length) {
            container.innerHTML = '<p>Ничего не найдено по выбранным фильтрам.</p>';
            return;
        }
        const isAuthenticated = "{{ .isAuthenticated }}" === "true"
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';

            const img = product.images?.[0]?.image_url || '/web/static/img/primer.webp';
            const inCartClass = product.in_cart ? 'add-to-cart active' : 'add-to-cart';
            const inFavoritesClass = product.in_favorites ? 'add-to-favorites active' : 'add-to-favorites';
            card.innerHTML = `
            <div class="product-thumb">
                ${isAuthenticated ? `<button class="${inFavoritesClass}" onclick="addToFavorites(${product.id})">♡</button>` : ''}
                <span class="product-price">${formatPrice(product.price)} ₽</span>
                <img src="${img}" class="product-img" alt="${product.brand?.name || ''}">
            </div>
            <div class="product-body">
                <p class="product-title">${product.title}</p>
                <div class="product-tags">
                    <span>${product.type?.name || ''}</span>
                    <span>до ${product.recommended_area} м²</span>
                    <span>${product.min_noise_level} дБ</span>
                </div>
                ${isAuthenticated ? `<button class="${inCartClass}" onclick="addToCart(${product.id})">В корзину</button>` : ''}
            </div>
        `;
            container.appendChild(card);
        });
    }

    function formatPrice(price) {
        return (price / 100).toLocaleString('ru-RU'); // если цена в копейках
    }


    const areaLabels = [
        "менее 24",
        "24,1–29",
        "29,1–34",
        "34,1–49",
        "49,1–69",
        "69,1 и более"
    ];
    const areaValues = [
        "0-24",
        "24,1–29",
        "29,1–34",
        "34,1–49",
        "49,1–69",
        "69,1-10000"
    ];
    const powerLabels = [
        "2,0–2,2 кВт",
        "2,5–2,7 кВт",
        "3-3,5 кВт",
        "5–5,2 кВт",
        "7 кВт"
    ];

    const powerValues = [
        "2,0–2,2",
        "2,5–2,7",
        "3-3,5",
        "5–5,2",
        "7"
    ];
    const areaRange = document.getElementById("area-range");
    const areaLabel = document.getElementById("area-range-label");
    const powerRange = document.getElementById("power-range");
    const powerLabel = document.getElementById("cooling-range-label");

    areaLabel.textContent = areaLabels[areaRange.value];
    powerLabel.textContent = powerLabels[powerRange.value];

    areaRange.addEventListener("input", () => {
        areaLabel.textContent = areaLabels[areaRange.value];
    });

    powerRange.addEventListener("input", () => {
        powerLabel.textContent = powerLabels[powerRange.value];
    });

    // Радиокнопки: визуальное выделение при выборе
    document.querySelectorAll(".radio-button input").forEach(input => {
        if (input.name === "cost") {
            return
        }
        input.addEventListener("change", () => {
            const name = input.name;
            document.querySelectorAll(`.radio-button input[name="${name}"]`).forEach(el => {
                el.parentElement.classList.remove("checked");
            });
            input.parentElement.classList.add("checked");
        });
    });

    // Чекбоксы: визуальное выделение при выборе
    document.querySelectorAll(".checkbox-button input").forEach(input => {
        input.addEventListener("change", () => {
            input.parentElement.classList.toggle("checked", input.checked);
        });
    });


    function addToCart(id) {
        fetch("/api/cart", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({split_system_id: id})
        })
            .then(data => {
                alert("Ответ с сервера: " + data);
                renderProducts(data.items)
            })
            .catch(err => {
                alert("Ошибка: " + err);
            });
    }

    function addToFavorites(id) {
        fetch("/api/favorites", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({split_system_id: id})
        })
            .then(data => {
                alert("Ответ с сервера: " + data);
                renderProducts(data.items)
            })
            .catch(err => {
                alert("Ошибка: " + err);
            });
    }
</script>


<script>
    document.querySelectorAll('.checkbox-button').forEach(label => {
        const input = label.querySelector('input');
        label.addEventListener('click', () => {
            input.checked = !input.checked;
            label.classList.toggle('checked', input.checked);
        });
    });

    // Cooling Capacity Range
    const coolingRange = document.getElementById('cooling-capacity-range');
    const coolingLabel = document.getElementById('cooling-capacity-label');
    coolingRange.addEventListener('input', () => {
        const values = ['2,0–2,2 кВт', '2,5-2,7 квт', '3-3,5 квт', '5-5,2 квт', '7 квт'];
        coolingLabel.textContent = values[coolingRange.value - 1];
    });
</script>

<script src="/web/static/notify/simple-notify.min.js"></script>
<script src="/web/static/js/app.js"></script>
<!--<script src="/web/static/js/calculator.js"></script>-->
<script src="/web/static/js/utils.js"></script>
</body>
</html>